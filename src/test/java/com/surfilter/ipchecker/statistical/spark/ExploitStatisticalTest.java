package com.surfilter.ipchecker.statistical.spark;

import org.apache.log4j.Logger;
import org.apache.spark.sql.Row;
import org.junit.Test;

import java.util.List;

public class ExploitStatisticalTest {

    private static final Logger log = Logger.getLogger(ExploitStatisticalTest.class);

    @Test
    public void statistical() {
        String filePath = System.getProperty("user.dir").replace("\\", "/") + "/event/jiangxi/20180620110434";
        String ipUnitModelPath = filePath + "/ipunit_model.json";//根据ipstr匹配ip单位
        String statisticalPath = filePath + "/exploit_statistical.txt";//统计结果

        //不区分IOT ICS统计
        ExploitStatistical exploitStatistical = new ExploitStatistical(null, null, "江西");
        exploitStatistical.statistical(ipUnitModelPath, statisticalPath);
        //iot 物联统计
        ExploitStatistical IOTExploitStatistical = new ExploitStatistical("device.primary_type", "IOT", "江西");
        IOTExploitStatistical.statistical(ipUnitModelPath, statisticalPath);
        //ICS 工控统计
        ExploitStatistical ICSexploitStatistical = new ExploitStatistical("device.primary_type", "ICS", "江西");
        ICSexploitStatistical.statistical(ipUnitModelPath, statisticalPath);
    }

    @Test
    public void fieldCounterBySQL() {
        ExploitStatistical exploitStatistical = new ExploitStatistical(null, null, "测试");
        String filePath = System.getProperty("user.dir").replace("\\", "/") + "/event/jiangxi/20180620110434";
        String ipUnitModelPath = filePath + "/ipunit_model.json";
        List<Row> rowList = exploitStatistical.fieldCounterBySQL("ip_sources",
                "select `CVSS.riskLevel`,count(1) count from ip_sources where `CVSS.riskLevel`!=''group by `CVSS.riskLevel` order by count desc",
                ipUnitModelPath,
                null);
        for (Row row : rowList) {
            log.info(row.mkString());
        }
    }
}
