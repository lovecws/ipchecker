package com.surfilter.ipchecker.exploit;

import com.surfilter.ipchecker.common.db.JDBCService;
import com.surfilter.ipchecker.data.EsDataService;
import com.surfilter.ipchecker.util.Pinyin4jUtil;

import java.io.File;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.Map;

public class ExploitMain {
    private static final SimpleDateFormat dateFormat = new SimpleDateFormat("yyyyMMdd");
    private static final SimpleDateFormat longDateFormat = new SimpleDateFormat("yyyyMMddHHmmss");

    public static void exploit(String sourceEsHost, String sourceEsIndexName, String sourceEsIndexType, String sourceEsFieldName, String sourceEsFieldValue, int batchSize, String filePath) {
        if (sourceEsHost == null || sourceEsIndexName == null || sourceEsIndexType == null || sourceEsFieldName == null || sourceEsFieldValue == null) {
            throw new IllegalArgumentException("参数错误");
        }
        if (filePath == null) {
            filePath = System.getProperty("user.dir").replace("\\", "/");
        }
        String hanYuPinyinString = Pinyin4jUtil.toHanYuPinyinString(sourceEsFieldValue);
        filePath = filePath + "/event/" + hanYuPinyinString + "/" + longDateFormat.format(new Date());

        File eventDir = new File(filePath);
        if (!eventDir.exists()) {
            eventDir.mkdirs();
        }

        String sourcePath = filePath + "/source.json";//源文件
        String ipModelPath = filePath + "/ip_model.json";//根据ipstr匹配僵木控制事件
        String exploitModelPath = filePath + "/exploit_model.json";//匹配的漏洞
        String ipUnitModelPath = filePath + "/ipunit_model.json";//根据ipstr匹配ip单位
        String statisticalPath = filePath + "/exploit_statistical.txt";//统计结果

        //从数据源录入的字段数据
        String[] sourceFiedls = new String[]{"ip_str",
                "location.city.zh-CN",
                "product.vendor",
                "product.vendorcn",
                "device.primary_type",
                "device.secondary_type",
                "service",
                "has_exploit",
                "exploit.cvssbasescore",
                "exploit.exact",
                "exploit.uuid"};
        EsDataService esDataService = new EsDataService(sourceEsHost, sourceEsIndexName, sourceEsIndexType, sourceFiedls);
        Map<String, Object> paramMap = new HashMap<String, Object>();
        paramMap.put(sourceEsFieldName, sourceEsFieldValue);
        esDataService.extractData(paramMap, batchSize, sourcePath);

        //往数据模型里面添加 运营商和僵木控制字段
        String partPath = System.getProperty("user.dir").replace("\\", "/") + "/event/jiangxi/20180612160305";
        String checkerPath = partPath + "/part-00000";
        IPModel ipModel = new IPModel();
        ipModel.model(sourcePath, checkerPath, ipModelPath);

        //往数据模型添加 recordFields 等字段
        String[] recordFields = new String[]{"vulnerability.vulType",
                "vulnerability.threadType",
                "vulnerability.cnnvd",
                "vulnerability.cve",
                "CVSS.riskLevel",
                "product.vendor"};
        ExploitModel exploitModel = new ExploitModel(sourceEsHost, "vulnerability", "base", recordFields);
        exploitModel.model(ipModelPath, exploitModelPath);

        //根据ip地址查询ip地址单位信息
        IPUnitModel ipUnitModel = new IPUnitModel("oracle.jdbc.driver.OracleDriver", "jdbc:oracle:thin:@localhost:11521:orcl", "smcs_jx", "smcs");
        ipUnitModel.model(exploitModelPath, ipUnitModelPath);

        //不区分IOT ICS统计
        ExploitStatistical exploitStatistical = new ExploitStatistical(null, null);
        exploitStatistical.statistical(ipUnitModelPath, statisticalPath);
        //iot 物联统计
        ExploitStatistical IOTExploitStatistical = new ExploitStatistical("device.primary_type", "IOT");
        IOTExploitStatistical.statistical(ipUnitModelPath, statisticalPath);
        //ICS 工控统计
        ExploitStatistical ICSexploitStatistical = new ExploitStatistical("device.primary_type", "ICS");
        ICSexploitStatistical.statistical(ipUnitModelPath, statisticalPath);

        //将统计出来的结果保存到oracle数据库中
        JDBCService jdbcService = new JDBCService();
        jdbcService.buildJSONData(ipUnitModelPath, "ipchecker_" + hanYuPinyinString + "_" + dateFormat.format(new Date()), false);
    }

    public static void main(String[] args) {
        exploit("http://172.31.134.229:9200", "wscan", "base", "location.region.zh-CN.untouched", "江西", 1000, null);
    }
}
